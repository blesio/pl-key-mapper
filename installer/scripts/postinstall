#!/bin/zsh
set -euo pipefail

state_path="/tmp/com.local.RemapKeysForPLLanguage.MenuBar.pkg-state"
label="com.local.RemapKeysForPLLanguage.MenuBar"
app_name="Remap Keys for Polish Language"
legacy_app_name="Remap Keys for PL Language"
exec_name="RemapKeysForPLLanguageMenuBar"
logged_in_user="$(/usr/bin/stat -f%Su /dev/console || true)"
was_installed=0

if [[ -f "$state_path" ]]; then
  was_installed="$(/bin/cat "$state_path" 2>/dev/null || printf '0')"
fi
/bin/rm -f "$state_path"

if [[ -z "$logged_in_user" || "$logged_in_user" == "root" ]]; then
  exit 0
fi

uid="$(/usr/bin/id -u "$logged_in_user")"
plist_dir="/Users/$logged_in_user/Library/LaunchAgents"
plist_path="$plist_dir/$label.plist"
payload_root="/Library/Application Support/RemapKeysForPolishLanguageMenuBarInstaller"
payload_archive="$payload_root/RemapKeysForPolishLanguage.app.tar.gz"
user_app_root="/Users/$logged_in_user/Applications"
local_app_dir="/Users/$logged_in_user/Library/Application Support/Remap Keys for Polish Language"
local_app_path="$local_app_dir/$app_name.app"
legacy_local_app_dir="/Users/$logged_in_user/Library/Application Support/Remap Keys for PL Language"
legacy_local_app_path="$legacy_local_app_dir/$legacy_app_name.app"
system_app_path="/Applications/$app_name.app"
user_app_path="/Users/$logged_in_user/Applications/$app_name.app"
legacy_system_app_path="/Applications/$legacy_app_name.app"
legacy_user_app_path="/Users/$logged_in_user/Applications/$legacy_app_name.app"
prefs_path="/Users/$logged_in_user/Library/Preferences/com.local.RemapKeysForPLLanguage.menubar.plist"

stop_service() {
  /bin/launchctl bootout "gui/$uid/$label" >/dev/null 2>&1 || true
  /bin/launchctl bootout "gui/$uid" "$plist_path" >/dev/null 2>&1 || true
  /usr/bin/pkill -f "$exec_name" >/dev/null 2>&1 || true
}

install_current() {
  installed_app_path="$user_app_path"
  install_root="$user_app_root"

  /bin/mkdir -p "$plist_dir" "$user_app_root" "$local_app_dir"
  /usr/sbin/chown "$logged_in_user":staff "$user_app_root" "$local_app_dir" >/dev/null 2>&1 || true

  /bin/rm -rf "$user_app_path" "$local_app_path" "$system_app_path" "$legacy_user_app_path" "$legacy_local_app_path" "$legacy_system_app_path"
  if ! /usr/bin/tar -xzf "$payload_archive" -C "$install_root" >/dev/null 2>&1; then
    install_root="$local_app_dir"
    installed_app_path="$local_app_path"
    /bin/rm -rf "$installed_app_path"
    /usr/bin/tar -xzf "$payload_archive" -C "$install_root"
  fi
  /usr/sbin/chown -R "$logged_in_user":staff "$installed_app_path" >/dev/null 2>&1 || true

  cat > "$plist_path" << PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>$label</string>
    <key>ProgramArguments</key>
    <array>
        <string>$installed_app_path/Contents/MacOS/$exec_name</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
</dict>
</plist>
PLIST

  /usr/sbin/chown "$logged_in_user":staff "$plist_path"
  /bin/chmod 644 "$plist_path"
  /usr/bin/xattr -dr com.apple.quarantine "$installed_app_path" >/dev/null 2>&1 || true

  stop_service
  /bin/launchctl bootstrap "gui/$uid" "$plist_path"
  /bin/launchctl kickstart -k "gui/$uid/$label" >/dev/null 2>&1 || true
  /bin/launchctl asuser "$uid" /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f "$installed_app_path" >/dev/null 2>&1 || /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f "$installed_app_path" >/dev/null 2>&1 || true
  /bin/rm -rf "$payload_root"
}

uninstall_current() {
  stop_service
  /bin/rm -f "$plist_path"
  /bin/rm -rf "$local_app_path" "$system_app_path" "$user_app_path" "$legacy_local_app_path" "$legacy_system_app_path" "$legacy_user_app_path"
  /bin/rmdir "$local_app_dir" >/dev/null 2>&1 || true
  /bin/rmdir "$legacy_local_app_dir" >/dev/null 2>&1 || true
  /bin/rm -f "$prefs_path"
  /bin/rm -rf "$payload_root"
  /bin/launchctl asuser "$uid" /usr/bin/hidutil property --set '{"UserKeyMapping":[]}' >/dev/null 2>&1 || /usr/bin/hidutil property --set '{"UserKeyMapping":[]}' >/dev/null 2>&1 || true
}

if [[ "$was_installed" == "1" ]]; then
  uninstall_current
else
  install_current
fi

exit 0
